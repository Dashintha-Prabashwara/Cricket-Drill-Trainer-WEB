<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player Dashboard</title>
    <!-- Updated EmailJS SDK -->
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"
    ></script>
    <script>
      // Initialize EmailJS once with latest API
      (function () {
        emailjs.init({
          publicKey: "YOUR_PUBLIC_KEY", // Replace with your EmailJS public key
        });
      })();
    </script>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .container {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 8px 32px rgba(44, 62, 80, 0.12);
        overflow: hidden;
        width: 100%;
        max-width: 900px;
        margin: 24px;
      }

      .header {
        background: linear-gradient(90deg, #2d3e50 0%, #4facfe 100%);
        color: #fff;
        padding: 2rem 1rem;
        text-align: center;
        border-bottom: 1px solid #e1e5e9;
      }

      .header h1 {
        font-size: 2.3rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
        letter-spacing: 1px;
      }

      .header p {
        opacity: 0.85;
        font-size: 1.05rem;
        font-weight: 500;
      }

      .content {
        padding: 2rem;
      }

      .auth-section,
      .dashboard-section {
        display: none;
      }

      .auth-section.active,
      .dashboard-section.active {
        display: block;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 1.5px solid #e1e5e9;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
        background: #f8f9fa;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4facfe;
        background: #fff;
      }

      .btn {
        background: linear-gradient(90deg, #2d3e50 0%, #4facfe 100%);
        color: #fff;
        border: none;
        padding: 12px 32px;
        border-radius: 22px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: box-shadow 0.2s, background 0.2s;
        margin-right: 10px;
        margin-bottom: 10px;
        box-shadow: 0 2px 8px rgba(44, 62, 80, 0.08);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn.secondary {
        background: linear-gradient(90deg, #3f5efb 0%, #fc466b 100%);
      }

      .btn.danger {
        background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
      }

      .btn.success {
        background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
      }

      .btn.warning {
        background: linear-gradient(90deg, #ff9a56 0%, #ff6a00 100%);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn:hover:not(:disabled) {
        box-shadow: 0 4px 16px rgba(44, 62, 80, 0.18);
        background: linear-gradient(90deg, #4facfe 0%, #2d3e50 100%);
      }

      .tabs {
        display: flex;
        border-bottom: 2px solid #e1e5e9;
        margin-bottom: 2rem;
        gap: 2rem;
        justify-content: center;
        padding: 0 1rem; 
      }

      .tab {
        background: #f8f9fa;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        transition: background 0.3s, color 0.3s;
        color: #2d3e50;
        border-bottom: 2px solid transparent;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
        padding: 1rem 2rem;
      }

      .tab.active {
        background: linear-gradient(90deg, #4facfe 0%, #2d3e50 100%);
        color: #fff;
        border-bottom: 2px solid #4facfe;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .message {
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        display: none;
      }

      .message.success {
        display: block;
        background: #eafaf1;
        color: #11998e;
        border: 1px solid #38ef7d;
      }

      .message.error {
        display: block;
        background: #f8d7da;
        color: #c0392b;
        border: 1px solid #e74c3c;
      }

      .user-info {
        background: #e3f2fd;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        text-align: center;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 2rem;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4facfe;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      #submissions,
      #registeredPlayers {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 1rem;
      }

      #submissions p,
      #registeredPlayers p {
        background: white;
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 10px;
        border-left: 4px solid #4facfe;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
      }

      #submissions p:hover,
      #registeredPlayers p:hover {
        transform: translateX(5px);
      }

      .player-card {
        background: white;
        padding: 1.5rem;
        margin: 0.5rem 0;
        border-radius: 15px;
        border-left: 4px solid #11998e;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .player-card:hover {
        transform: translateX(5px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .player-card-header,
      .player-card,
      .player-details-container.expanded {
        box-shadow: 0 2px 12px rgba(44, 62, 80, 0.08);
      }

      .player-card-header {
        background: #f8f9fa;
        border-left: 4px solid #4facfe;
        border-radius: 14px;
        padding: 1rem 1.5rem;
        margin: 0.5rem 0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: box-shadow 0.2s, border-color 0.2s;
      }

      .player-card-header:hover {
        border-left-color: #11998e;
        box-shadow: 0 6px 20px rgba(44, 62, 80, 0.15);
      }

      .player-id {
        font-size: 1.1rem;
        font-weight: bold;
        color: #11998e;
      }

      .player-timestamp {
        font-size: 0.9rem;
        color: #666;
      }

      .player-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .player-detail {
        display: flex;
        flex-direction: column;
      }

      .player-detail-label {
        font-size: 0.85rem;
        color: #666;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .player-detail-value {
        font-size: 1rem;
        color: #333;
        font-weight: 500;
      }

      .search-filter {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .search-filter input {
        width: 100%;
        padding: 12px;
        border: 1.5px solid #e1e5e9;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      .search-filter input:focus {
        outline: none;
        border-color: #4facfe;
      }

      .email-status {
        padding: 0.5rem;
        margin-top: 0.5rem;
        border-radius: 5px;
        font-size: 0.95rem;
        text-align: center;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
      }

      .email-status.sending {
        background: #fff3cd;
        color: #ff9a56;
        border: 1px solid #ffeaa7;
      }

      .email-status.sent {
        background: #eafaf1;
        color: #11998e;
        border: 1px solid #38ef7d;
      }

      .email-status.failed {
        background: #f8d7da;
        color: #c0392b;
        border: 1px solid #e74c3c;
      }

      /* NEW: Real-time angle monitoring styles */
      .angle-monitor-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border-left: 4px solid #4facfe;
        box-shadow: 0 2px 12px rgba(44, 62, 80, 0.08);
      }

      .angle-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .realtime-display {
        background: #23272f;
        color: #38ef7d;
        padding: 2rem;
        border-radius: 10px;
        text-align: center;
        font-family: "Courier New", monospace;
        margin-bottom: 1rem;
        box-shadow: inset 0 2px 10px rgba(44, 62, 80, 0.18);
      }

      .angle-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0.5rem 0;
        text-shadow: 0 0 10px #38ef7d;
      }

      .angle-label {
        font-size: 1rem;
        opacity: 0.8;
        margin-bottom: 0.5rem;
      }

      .connection-status {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 1rem;
        text-align: center;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
      }

      .connection-status.connected {
        background: #eafaf1;
        color: #11998e;
        border: 1px solid #38ef7d;
      }

      .connection-status.disconnected {
        background: #f8d7da;
        color: #c0392b;
        border: 1px solid #e74c3c;
      }

      .connection-status.connecting {
        background: #fff3cd;
        color: #ff9a56;
        border: 1px solid #ffeaa7;
      }

      .angle-input-readonly {
        background-color: #e9ecef !important;
        cursor: not-allowed;
      }

      @media (max-width: 768px) {
        .container {
          margin: 10px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .content {
          padding: 1rem;
        }

        .tabs {
          flex-direction: column;
        }

        .player-details {
          grid-template-columns: 1fr;
        }

        .angle-controls {
          grid-template-columns: 1fr;
        }

        .angle-value {
          font-size: 2rem;
        }
      }

      .angle-input-container {
        position: relative;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .reset-angle-btn {
        background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: box-shadow 0.2s, background 0.2s;
        min-width: 60px;
        height: 44px;
        display: flex;
        align-items: center;
        gap: 6px;
        justify-content: center;
      }

      .reset-angle-btn:hover:not(:disabled) {
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.18);
        background: linear-gradient(90deg, #c0392b 0%, #e74c3c 100%);
      }

      .reset-angle-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
      }

      .angle-input-container input {
        flex: 1;
        margin: 0;
      }

      .form-group .angle-input-container {
        width: 100%;
      }

      .segment-header {
        grid-column: 1 / -1;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid #e1e5e9;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        padding: 0.75rem;
      }

      .segment-header .player-detail-label {
        color: #495057;
        font-size: 1rem;
        font-weight: bold;
        text-align: center;
        margin: 0;
      }

      .foot-segment .segment-header .player-detail-label {
        color: #11998e;
      }

      .bat-segment .segment-header .player-detail-label {
        color: #ff9a56;
      }

      /* Performance metrics styling */
      .performance-metric {
        background: rgba(79, 172, 254, 0.1);
        border-radius: 8px;
        padding: 0.5rem;
        border-left: 3px solid #4facfe;
      }

      .foot-performance .performance-metric {
        background: rgba(17, 153, 142, 0.1);
        border-left-color: #11998e;
      }

      .bat-performance .performance-metric {
        background: rgba(255, 154, 86, 0.1);
        border-left-color: #ff9a56;
      }

      .enhanced-performance-indicator {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: bold;
        margin-left: 0.5rem;
        display: inline-block;
      }

      .standard-performance-indicator {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: bold;
        margin-left: 0.5rem;
        display: inline-block;
      }

      .grip-performance-section {
        background: rgba(255, 107, 107, 0.05);
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
        border-left: 4px solid #ff6b6b;
        grid-column: 1 / -1;
      }

      .angle-performance-section {
        background: rgba(255, 154, 86, 0.05);
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
        border-left: 4px solid #ff9a56;
        grid-column: 1 / -1;
      }

      .performance-value-excellent {
        color: #11998e !important;
        font-weight: bold !important;
      }

      .performance-value-good {
        color: #4facfe !important;
        font-weight: bold !important;
      }

      .performance-value-poor {
        color: #e53e3e !important;
        font-weight: bold !important;
      }

      .segment-header {
        grid-column: 1 / -1;
        margin-top: 1rem;
        padding: 1rem;
        border-top: 2px solid #e1e5e9;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        text-align: center;
      }

      .segment-header .player-detail-label {
        color: #495057;
        font-size: 1.1rem;
        font-weight: bold;
        margin: 0;
      }

      .foot-segment .segment-header {
        background: linear-gradient(
          135deg,
          rgba(17, 153, 142, 0.1) 0%,
          rgba(56, 239, 125, 0.1) 100%
        );
        border-top-color: #11998e;
      }

      .foot-segment .segment-header .player-detail-label {
        color: #11998e;
      }

      .bat-segment .segment-header {
        background: linear-gradient(
          135deg,
          rgba(255, 154, 86, 0.1) 0%,
          rgba(255, 106, 0, 0.1) 100%
        );
        border-top-color: #ff9a56;
      }

      .bat-segment .segment-header .player-detail-label {
        color: #ff9a56;
      }

      .performance-metric {
        background: rgba(79, 172, 254, 0.08);
        border-radius: 8px;
        padding: 0.75rem;
        border-left: 3px solid #4facfe;
        transition: all 0.2s ease;
      }

      .performance-metric:hover {
        background: rgba(79, 172, 254, 0.12);
        transform: translateX(2px);
      }

      .foot-performance .performance-metric {
        background: rgba(17, 153, 142, 0.08);
        border-left-color: #11998e;
      }

      .foot-performance .performance-metric:hover {
        background: rgba(17, 153, 142, 0.12);
      }

      .bat-performance .performance-metric {
        background: rgba(255, 154, 86, 0.08);
        border-left-color: #ff9a56;
      }

      .bat-performance .performance-metric:hover {
        background: rgba(255, 154, 86, 0.12);
      }

      .data-type-enhanced {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .data-type-standard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      @media (max-width: 768px) {
        .segment-header .player-detail-label {
          font-size: 1rem;
        }

        .performance-metric {
          padding: 0.5rem;
        }

        .enhanced-performance-indicator,
        .standard-performance-indicator {
          font-size: 0.7rem;
          padding: 0.2rem 0.5rem;
        }
      }

      .player-card-header {
        background: white;
        padding: 1rem 1.5rem;
        margin: 0.5rem 0;
        border-radius: 15px;
        border-left: 4px solid #11998e;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .player-card-header:hover {
        transform: translateX(5px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .player-summary {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        align-items: center;
        flex: 1;
      }

      .player-summary-item {
        display: flex;
        flex-direction: column;
      }

      .player-summary-label {
        font-size: 0.8rem;
        color: #666;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .player-summary-value {
        font-size: 1rem;
        color: #333;
        font-weight: 600;
      }

      .expand-arrow {
        font-size: 1.2rem;
        color: #11998e;
        transition: transform 0.3s ease;
        margin-left: 1rem;
      }

      .expand-arrow.expanded {
        transform: rotate(180deg);
      }

      .player-details-container {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: #f8f9fa;
        border-radius: 0 0 15px 15px;
        margin-top: -0.5rem;
        margin-bottom: 0.5rem;
      }

      .player-details-container.expanded {
        max-height: 2000px;
        padding: 1.5rem;
        border-left: 4px solid #11998e;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .submission-card-header {
        border-left-color: #4facfe;
      }

      .submission-summary {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        align-items: center;
        flex: 1;
      }

      .submission-expand-arrow {
        color: #4facfe;
      }

      @media (max-width: 768px) {
        .player-summary,
        .submission-summary {
          gap: 1rem;
        }

        .player-summary-item {
          min-width: 120px;
        }

        .expand-arrow {
          font-size: 1rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fa-solid fa-user-group"></i> Player Dashboard</h1>
        <p>Player Registration & Management System</p>
      </div>

      <div class="content">
        <!-- Login Section -->
        <div class="auth-section active" id="loginSection">
          <h2 style="text-align: center; margin-bottom: 2rem; color: #333">
            <i class="fa-solid fa-right-to-bracket"></i> Player Login
          </h2>

          <div class="message" id="loginMessage"></div>

          <form id="loginForm">
            <div class="form-group">
              <label for="username"><i class="fa-solid fa-user"></i> Username:</label>
              <input type="text" id="username" name="username" required />
            </div>

            <div class="form-group">
              <label for="password"><i class="fa-solid fa-lock"></i> Password:</label>
              <input type="password" id="password" name="password" required />
            </div>

            <div style="text-align: center">
              <button type="submit" class="btn"><i class="fa-solid fa-arrow-right"></i> Login</button>
            </div>
          </form>

          <div style="text-align: center; margin-top: 1rem; color: #666">
            <p>Demo credentials:</p>
            <p>
              <strong>Username:</strong> admin <strong>Password:</strong> 1234
            </p>
          </div>
        </div>

        <!-- Dashboard Section -->
        <div class="dashboard-section" id="dashboardSection">
          <div class="user-info">
            <h3>
              Welcome, <span id="currentUser"></span>!
            </h3>
            <button class="btn danger" onclick="logout()">
              <i class="fa-solid fa-right-from-bracket"></i> Logout
            </button>
          </div>

          <div class="tabs">
            <button class="tab active" onclick="switchTab('register', event)">
              Register Player
            </button>
            <button class="tab" onclick="switchTab('registered', event)">
              Registered Players
            </button>
            <button class="tab" onclick="switchTab('submissions', event)">
              Player Submissions
            </button>
          </div>

          <!-- Register Player Tab -->
          <div class="tab-content active" id="registerTab">
            <h3 style="margin-bottom: 1.5rem">
              <i class="fa-solid fa-user-plus"></i> Register New Player
            </h3>

            <div class="message" id="registerMessage"></div>

            <form id="registerForm">
              <div class="form-group">
                <label for="playerHandedness">Handedness:</label>
                <select id="playerHandedness" name="playerHandedness" required>
                  <option value>Select Handedness</option>
                  <option value="1">Left Handed</option>
                  <option value="2">Right Handed</option>
                </select>
              </div>

              <div class="form-group">
                <label for="playerName">Full Name:</label>
                <input type="text" id="playerName" name="playerName" required />
              </div>

              <div class="form-group">
                <label for="playerAge">Age:</label>
                <input
                  type="number"
                  id="playerAge"
                  name="playerAge"
                  min="5"
                  max="100"
                  required
                />
              </div>

              <div class="form-group">
                <label for="playerEmail">Email Address:</label>
                <input
                  type="email"
                  id="playerEmail"
                  name="playerEmail"
                  required
                  placeholder="Enter email address for player ID notification"
                />
              </div>

              <!-- Real-time Angle Monitor Section -->
              <div class="angle-monitor-section">
                <h4 style="margin-bottom: 1rem; color: #4facfe">
                  <i class="fa-solid fa-wave-square"></i> Real-time Angle Monitor
                </h4>

                <div id="connectionStatus" class="connection-status disconnected">
                  <i class="fa-solid fa-circle-xmark"></i> Not Connected to the Bat Segment
                </div>

                <div class="angle-controls">
                  <div class="form-group">
                    <label for="esp32IpAddress"><i class="fa-solid fa-network-wired"></i> Bat Segment IP Address:</label>
                    <input type="text" id="esp32IpAddress" placeholder="10.34.29.41" value="10.34.29.41" />
                  </div>

                  <div class="form-group">
                    <label for="selectedAngleType"><i class="fa-solid fa-ruler-combined"></i> Select Angle to Measure:</label>
                    <select id="selectedAngleType">
                      <option value="stanceAngle">Stance Angle</option>
                      <option value="forwardDefenceEndAngle">
                        Forward Defence End Angle
                      </option>
                      <option value="forwardDriveEndAngle">
                        Forward Drive End Angle
                      </option>
                      <option value="backwardDefenceEndAngle">
                        Backward Defence End Angle
                      </option>
                      <option value="backwardDriveEndAngle">
                        Backward Drive End Angle
                      </option>
                      <option value="cutEndAngle">Cut End Angle</option>
                      <option value="pullEndAngle">Pull End Angle</option>
                    </select>
                  </div>
                </div>

                <div class="realtime-display">
                  <div class="angle-label">Main Angle:</div>
                  <div class="angle-value" id="realtimeAngle">0.0°</div>

                  <div
                    style="
                      display: grid;
                      grid-template-columns: 1fr 1fr;
                      gap: 1rem;
                      margin-top: 1rem;
                    "
                  >
                    <div style="text-align: center">
                      <div class="angle-label" style="font-size: 0.9rem">
                        Pitch:
                      </div>
                      <div
                        class="angle-value"
                        id="realtimePitch"
                        style="font-size: 2rem"
                      >
                        0.0°
                      </div>
                    </div>
                    <div style="text-align: center">
                      <div class="angle-label" style="font-size: 0.9rem">
                        Roll:
                      </div>
                      <div
                        class="angle-value"
                        id="realtimeRoll"
                        style="font-size: 2rem"
                      >
                        0.0°
                      </div>
                    </div>
                  </div>

                  <div
                    style="font-size: 0.9rem; opacity: 0.7; margin-top: 1rem"
                    id="angleStatus"
                  >
                    Waiting for data...
                  </div>
                </div>

                <div style="text-align: center">
                  <button
                    type="button"
                    class="btn warning"
                    id="connectBtn"
                    onclick="toggleConnection()"
                  >
                    <i class="fa-solid fa-plug"></i> Connect to Bat Segment
                  </button>
                  <button
                    type="button"
                    class="btn success"
                    id="captureAngleBtn"
                    onclick="captureCurrentAngle()"
                    disabled
                  >
                    <i class="fa-solid fa-thumbtack"></i> Capture Angle
                  </button>
                </div>
              </div>

              <!-- Current Angle Measurements Display -->
              <div class="angle-monitor-section">
                <h4 style="margin-bottom: 1rem; color: #4facfe">
                  Captured Angle Measurements
                </h4>

                <div id="currentAnglesDisplay" class="player-card">
                  <div class="player-header">
                    <div class="player-id">Current Session Angles</div>
                    <div class="player-timestamp" id="anglesTimestamp">
                      Not set
                    </div>
                  </div>
                  <div class="player-details">
                    <div class="player-detail">
                      <div class="player-detail-label">Stance Angle</div>
                      <div class="player-detail-value" id="displayStanceAngle">
                        Not captured
                      </div>
                    </div>
                    <div class="player-detail">
                      <div class="player-detail-label">
                        Forward Defence End Angle
                      </div>
                      <div
                        class="player-detail-value"
                        id="displayForwardDefenceEndAngle"
                      >
                        Not captured
                      </div>
                    </div>
                    <div class="player-detail">
                      <div class="player-detail-label">
                        Forward Drive End Angle
                      </div>
                      <div
                        class="player-detail-value"
                        id="displayForwardDriveEndAngle"
                      >
                        Not captured
                      </div>
                    </div>
                    <div class="player-detail">
                      <div class="player-detail-label">
                        Backward Defence End Angle
                      </div>
                      <div
                        class="player-detail-value"
                        id="displayBackwardDefenceEndAngle"
                      >
                        Not captured
                      </div>
                    </div>
                    <div class="player-detail">
                      <div class="player-detail-label">
                        Backward Drive End Angle
                      </div>
                      <div
                        class="player-detail-value"
                        id="displayBackwardDriveEndAngle"
                      >
                        Not captured
                      </div>
                    </div>
                    <div class="player-detail">
                      <div class="player-detail-label">Cut End Angle</div>
                      <div class="player-detail-value" id="displayCutEndAngle">
                        Not captured
                      </div>
                    </div>
                    <div class="player-detail">
                      <div class="player-detail-label">Pull End Angle</div>
                      <div class="player-detail-value" id="displayPullEndAngle">
                        Not captured
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div style="text-align: center">
                <button type="submit" class="btn"><i class="fa-solid fa-user-plus"></i> Register Player</button>
              </div>
            </form>

            <div id="emailStatus" class="email-status" style="display: none"></div>

            <div class="form-group">
              <label for="stanceAngle">Stance Angle (degrees):</label>
              <div class="angle-input-container">
                <input
                  type="number"
                  id="stanceAngle"
                  name="stanceAngle"
                  step="0.1"
                  min="0"
                  max="360"
                  required
                  placeholder="Enter stance angle"
                  readonly
                />
                <button
                  type="button"
                  class="reset-angle-btn"
                  onclick="resetAngleField('stanceAngle')"
                >
                  <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="forwardDefenceEndAngle"
                >Forward Defence End Angle (degrees):</label
              >
              <div class="angle-input-container">
                <input
                  type="number"
                  id="forwardDefenceEndAngle"
                  name="forwardDefenceEndAngle"
                  step="0.1"
                  min="0"
                  max="360"
                  required
                  placeholder="Enter forward defence end angle"
                  readonly
                />
                <button
                  type="button"
                  class="reset-angle-btn"
                  onclick="resetAngleField('forwardDefenceEndAngle')"
                >
                  <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="forwardDriveEndAngle"
                >Forward Drive End Angle (degrees):</label
              >
              <div class="angle-input-container">
                <input
                  type="number"
                  id="forwardDriveEndAngle"
                  name="forwardDriveEndAngle"
                  step="0.1"
                  min="0"
                  max="360"
                  required
                  placeholder="Enter forward drive end angle"
                  readonly
                />
                <button
                  type="button"
                  class="reset-angle-btn"
                  onclick="resetAngleField('forwardDriveEndAngle')"
                >
                  <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="backwardDefenceEndAngle"
                >Backward Defence End Angle (degrees):</label
              >
              <div class="angle-input-container">
                <input
                  type="number"
                  id="backwardDefenceEndAngle"
                  name="backwardDefenceEndAngle"
                  step="0.1"
                  min="0"
                  max="360"
                  required
                  placeholder="Enter backward defence end angle"
                  readonly
                />
                <button
                  type="button"
                  class="reset-angle-btn"
                  onclick="resetAngleField('backwardDefenceEndAngle')"
                >
                  <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="backwardDriveEndAngle"
                >Backward Drive End Angle (degrees):</label
              >
              <div class="angle-input-container">
                <input
                  type="number"
                  id="backwardDriveEndAngle"
                  name="backwardDriveEndAngle"
                  step="0.1"
                  min="0"
                  max="360"
                  required
                  placeholder="Enter backward drive end angle"
                  readonly
                />
                <button
                  type="button"
                  class="reset-angle-btn"
                  onclick="resetAngleField('backwardDriveEndAngle')"
                >
                  <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="cutEndAngle">Cut End Angle (degrees):</label>
              <div class="angle-input-container">
                <input
                  type="number"
                  id="cutEndAngle"
                  name="cutEndAngle"
                  step="0.1"
                  min="0"
                  max="360"
                  required
                  placeholder="Enter cut end angle"
                  readonly
                />
                <button
                  type="button"
                  class="reset-angle-btn"
                  onclick="resetAngleField('cutEndAngle')"
                >
                  <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="pullEndAngle">Pull End Angle (degrees):</label>
              <div class="angle-input-container">
                <input
                  type="number"
                  id="pullEndAngle"
                  name="pullEndAngle"
                  step="0.1"
                  min="0"
                  max="360"
                  required
                  placeholder="Enter pull end angle"
                  readonly
                />
                <button
                  type="button"
                  class="reset-angle-btn"
                  onclick="resetAngleField('pullEndAngle')"
                >
                  <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
              </div>
            </div>
          </div>

          <!-- Registered Players Tab -->
          <div class="tab-content" id="registeredTab">
            <h3 style="margin-bottom: 1.5rem">
              <i class="fa-solid fa-users"></i> Registered Players
            </h3>

            <div class="search-filter">
              <input
                type="text"
                id="playerSearch"
                placeholder="Search by Player ID, Name, or Email..."
                oninput="filterPlayers()"
                style="margin-bottom: 0"
              />
            </div>

            <div style="text-align: center; margin-bottom: 1rem">
              <button class="btn success" onclick="fetchRegisteredPlayers()">
                <i class="fa-solid fa-arrows-rotate"></i> Load Registered Players
              </button>
            </div>

            <div class="loading" id="registeredLoading">
              <div class="spinner"></div>
              <p>Loading registered players...</p>
            </div>

            <div id="registeredPlayers"></div>
          </div>

          <!-- Player Submissions Tab -->
          <div class="tab-content" id="submissionsTab">
            <h3 style="margin-bottom: 1.5rem">
              <i class="fa-solid fa-file-lines"></i> Player Submissions
            </h3>

            <div class="search-filter">
              <input
                type="text"
                id="submissionSearch"
                placeholder="Search by Player ID, Handedness, Drill Type, or Performance Data..."
                oninput="filterSubmissions()"
              />
            </div>

            <div style="text-align: center; margin-bottom: 1rem">
              <button class="btn secondary" onclick="fetchSubmissions()">
                <i class="fa-solid fa-arrows-rotate"></i> Load Submissions
              </button>
            </div>

            <div class="loading" id="submissionsLoading">
              <div class="spinner"></div>
              <p>Loading submissions...</p>
            </div>

            <div id="submissions"></div>
          </div>
        </div>
      </div>

      <script>
        // Global variable to store registered players data for filtering
        let allRegisteredPlayers = [];
        let allSubmissions = [];
        // NEW: WebSocket and angle monitoring variables
        let esp32WebSocket = null;
        let isConnected = false;
        let currentAngle = 0;
        let reconnectInterval = null;
        let connectionAttempts = 0;
        const MAX_RECONNECTION_ATTEMPTS = 5;

        // WebSocket connection functions
        function toggleConnection() {
          if (isConnected) {
            disconnectFromESP32();
          } else {
            connectToESP32();
          }
        }

        function connectToESP32() {
          const ipAddress = document
            .getElementById("esp32IpAddress")
            .value.trim();

          if (!ipAddress) {
            updateConnectionStatus(
              "disconnected",
              "❌ Please enter ESP32 IP address"
            );
            return;
          }

          // Update IP address placeholder if user changed it
          document.getElementById("esp32IpAddress").placeholder = ipAddress;
          // Validate IP address format
          const ipRegex =
            /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
          if (!ipRegex.test(ipAddress)) {
            updateConnectionStatus(
              "disconnected",
              "❌ Invalid IP address format"
            );
            return;
          }

          updateConnectionStatus("connecting", "🔄 Connecting to ESP32...");
          document.getElementById("connectBtn").disabled = true;

          try {
            console.log(`Attempting to connect to ws://${ipAddress}:81`);
            // Create WebSocket connection (assuming ESP32 runs WebSocket server on port 81)
            esp32WebSocket = new WebSocket(`ws://${ipAddress}:81`);

            esp32WebSocket.onopen = function (event) {
              console.log("Connected to Bat Segment");
              isConnected = true;
              connectionAttempts = 0;
              updateConnectionStatus("connected", "✅ Connected to Bat Segment");
              document.getElementById("connectBtn").textContent = "Disconnect";
              document.getElementById("connectBtn").disabled = false;
              document.getElementById("captureAngleBtn").disabled = false;
              document.getElementById("angleStatus").textContent =
                "Receiving data...";

              // Clear any reconnection interval
              if (reconnectInterval) {
                clearInterval(reconnectInterval);
                reconnectInterval = null;
              }
            };

            esp32WebSocket.onmessage = function (event) {
              try {
                const data = JSON.parse(event.data);

                if (data.pitch !== undefined) {
                  currentPitch = parseFloat(data.pitch).toFixed(1);
                }

                if (data.roll !== undefined) {
                  currentRoll = parseFloat(data.roll).toFixed(1);
                }

                // Update all available angle data
                let hasData = false;

                if (data.pitch !== undefined) {
                  document.getElementById("realtimePitch").textContent =
                    parseFloat(data.pitch).toFixed(1) + "°";
                  hasData = true;
                }

                if (data.roll !== undefined) {
                  document.getElementById("realtimeRoll").textContent =
                    parseFloat(data.roll).toFixed(1) + "°";
                  hasData = true;
                }

                if (data.angle !== undefined) {
                  currentAngle = parseFloat(data.angle).toFixed(1);
                  document.getElementById("realtimeAngle").textContent =
                    currentAngle + "°";
                  hasData = true;
                }

                if (hasData) {
                  document.getElementById(
                    "angleStatus"
                  ).textContent = `Live data (${new Date().toLocaleTimeString()})`;

                  // Add visual feedback for real-time updates
                  const angleDisplay = document.getElementById("realtimeAngle");
                  const pitchDisplay = document.getElementById("realtimePitch");
                  const rollDisplay = document.getElementById("realtimeRoll");

                  [angleDisplay, pitchDisplay, rollDisplay].forEach(
                    (display) => {
                      if (display) {
                        display.style.textShadow = "0 0 20px #00ff41";
                        setTimeout(() => {
                          display.style.textShadow = "0 0 10px #00ff41";
                        }, 200);
                      }
                    }
                  );
                }
              } catch (error) {
                console.error("Error parsing angle data:", error);
                document.getElementById("angleStatus").textContent =
                  "Data format error";
              }
            };

            esp32WebSocket.onclose = function (event) {
              console.log("Disconnected from ESP32");
              handleDisconnection();
            };

            esp32WebSocket.onerror = function (error) {
              console.error("WebSocket error:", error);
              console.error(
                "Connection failed. Make sure ESP32 is powered on and connected to the same network."
              );
              handleDisconnection();
            };

            // Add connection timeout
            setTimeout(() => {
              if (
                esp32WebSocket &&
                esp32WebSocket.readyState === WebSocket.CONNECTING
              ) {
                console.log("Connection timeout");
                esp32WebSocket.close();
                updateConnectionStatus(
                  "disconnected",
                  "❌ Connection timeout - Check ESP32 IP and network"
                );
                document.getElementById("connectBtn").disabled = false;
              }
            }, 10000);
          } catch (error) {
            console.error("Connection error:", error);
            handleDisconnection();
          }
        }

        function disconnectFromESP32() {
          if (esp32WebSocket) {
            esp32WebSocket.close();
          }
          handleDisconnection(true);
        }

        function handleDisconnection(manual = false) {
          isConnected = false;
          currentAngle = 0;

          document.getElementById("realtimeAngle").textContent = "0.0°";
          document.getElementById("connectBtn").textContent =
            "Connect to Bat Segment";
          document.getElementById("connectBtn").disabled = false;
          document.getElementById("captureAngleBtn").disabled = true;

          if (manual) {
            updateConnectionStatus("disconnected", "❌ Disconnected");
            document.getElementById("angleStatus").textContent =
              "Not connected";
            // Clear reconnection attempts
            if (reconnectInterval) {
              clearInterval(reconnectInterval);
              reconnectInterval = null;
            }
            connectionAttempts = 0;
          } else {
            // Automatic reconnection logic
            connectionAttempts++;
            if (connectionAttempts <= MAX_RECONNECTION_ATTEMPTS) {
              updateConnectionStatus(
                "connecting",
                `🔄 Reconnecting... (${connectionAttempts}/${MAX_RECONNECTION_ATTEMPTS})`
              );
              document.getElementById("angleStatus").textContent =
                "Reconnecting...";

              reconnectInterval = setTimeout(() => {
                connectToESP32();
              }, 3000);
            } else {
              updateConnectionStatus(
                "disconnected",
                "❌ Connection failed after multiple attempts"
              );
              document.getElementById("angleStatus").textContent =
                "Connection failed";
              connectionAttempts = 0;
            }
          }

          esp32WebSocket = null;
        }

        function updateConnectionStatus(status, message) {
          const statusElement = document.getElementById("connectionStatus");
          let icon = "";
          if (status === "connected") icon = '<i class="fa-solid fa-circle-check"></i>';
          else if (status === "disconnected") icon = '<i class="fa-solid fa-circle-xmark"></i>';
          else if (status === "connecting") icon = '<i class="fa-solid fa-spinner fa-spin"></i>';
          statusElement.className = `connection-status ${status}`;
          statusElement.innerHTML = icon + " " + message.replace(/^[^a-zA-Z0-9]+/, "");
        }

        let currentPitch = 0;
        let currentRoll = 0;
        // Object to store captured angle data with pitch and roll
        let capturedAngleData = {};

        function captureCurrentAngle() {
          if (!isConnected) {
            alert("Not connected to Bat Segment. Please connect first.");
            return;
          }

          const selectedAngleType =
            document.getElementById("selectedAngleType").value;
          const angleInput = document.getElementById(selectedAngleType);

          // Check if we have any angle data
          const availableAngles = [];
          if (currentAngle !== 0)
            availableAngles.push(`Main: ${currentAngle}°`);
          if (currentPitch !== 0)
            availableAngles.push(`Pitch: ${currentPitch}°`);
          if (currentRoll !== 0) availableAngles.push(`Roll: ${currentRoll}°`);

          if (availableAngles.length === 0) {
            alert(
              "No angle data available. Please ensure ESP32 is sending data."
            );
            return;
          }

          // Store all three values for this angle type
          capturedAngleData[selectedAngleType] = {
            mainAngle: parseFloat(currentAngle),
            pitch: parseFloat(currentPitch),
            roll: parseFloat(currentRoll),
            timestamp: new Date().toISOString(),
          };

          if (angleInput) {
            // Display the main angle in the input field
            angleInput.value = currentAngle;
            // Update the display box
            updateAngleDisplay(selectedAngleType, currentAngle);

            // Log all captured data
            console.log(`Captured ${selectedAngleType}:`, {
              main: currentAngle + "°",
              pitch: currentPitch + "°",
              roll: currentRoll + "°",
            });

            // Visual feedback
            const originalBg = angleInput.style.backgroundColor;
            angleInput.style.backgroundColor = "#d4edda";
            angleInput.style.transition = "background-color 0.3s ease";

            setTimeout(() => {
              angleInput.style.backgroundColor = originalBg;
              angleInput.classList.remove("angle-input-readonly");
            }, 2000);

            const captureBtn = document.getElementById("captureAngleBtn");
            const originalText = captureBtn.innerHTML;
            captureBtn.innerHTML = '<i class="fa-solid fa-circle-check"></i> Captured!';
            captureBtn.disabled = true;

            setTimeout(() => {
              captureBtn.innerHTML = originalText;
              captureBtn.disabled = false;
            }, 1500);
          }
        }

        // Function to update the angle display box
        function updateAngleDisplay(angleType, angleValue) {
          const displayElementId =
            "display" + angleType.charAt(0).toUpperCase() + angleType.slice(1);
          const displayElement = document.getElementById(displayElementId);

          if (displayElement) {
            displayElement.textContent = angleValue + "°";

            // Update timestamp
            document.getElementById("anglesTimestamp").textContent =
              new Date().toLocaleString();

            // Add visual feedback
            displayElement.style.color = "#11998e";
            displayElement.style.fontWeight = "bold";
            setTimeout(() => {
              displayElement.style.color = "#333";
              displayElement.style.fontWeight = "500";
            }, 2000);
          }
        }

        // Login functionality
        document
          .getElementById("loginForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            login();
          });

        function login() {
          const user = document.getElementById("username").value.trim();
          const pass = document.getElementById("password").value.trim();
          const loginMsg = document.getElementById("loginMessage");

          // Clear previous messages
          loginMsg.className = "message";
          loginMsg.textContent = "";

          if (user === "admin" && pass === "1234") {
            loginMsg.textContent = "Login successful!";
            loginMsg.className = "message success";

            setTimeout(() => {
              document
                .getElementById("loginSection")
                .classList.remove("active");
              document
                .getElementById("dashboardSection")
                .classList.add("active");
              document.getElementById("currentUser").textContent = user;
            }, 1000);
          } else {
            loginMsg.textContent = "Invalid credentials! Please try again.";
            loginMsg.className = "message error";
          }
        }

        // Logout functionality
        function logout() {
          // Disconnect from ESP32 if connected
          if (isConnected) {
            disconnectFromESP32();
          }

          document
            .getElementById("dashboardSection")
            .classList.remove("active");
          document.getElementById("loginSection").classList.add("active");
          document.getElementById("username").value = "";
          document.getElementById("password").value = "";
          document.getElementById("loginMessage").className = "message";
          document.getElementById("loginMessage").textContent = "";

          // Clear any registration messages
          document.getElementById("registerMessage").className = "message";
          document.getElementById("registerMessage").textContent = "";
          document.getElementById("emailStatus").style.display = "none";

          // Reset angle monitoring
          document.getElementById("esp32IpAddress").value = "10.34.29.41";
          document.getElementById("selectedAngleType").value = "stanceAngle";
          document.getElementById("realtimeAngle").textContent = "0.0°";
          document.getElementById("angleStatus").textContent =
            "Waiting for data...";
          updateConnectionStatus("disconnected", "Not Connected to the Bat Segment");

          // Clear registered players data
          allRegisteredPlayers = [];
          document.getElementById("registeredPlayers").innerHTML = "";
          document.getElementById("playerSearch").value = "";

          // Clear submissions data
          allSubmissions = [];
          document.getElementById("submissions").innerHTML = "";
          if (document.getElementById("submissionSearch")) {
            document.getElementById("submissionSearch").value = "";
          }
        }

        // Tab switching functionality
        function switchTab(tabName, event) {
          // Remove active class from all tabs and tab contents
          document
            .querySelectorAll(".tab")
            .forEach((tab) => tab.classList.remove("active"));
          document
            .querySelectorAll(".tab-content")
            .forEach((content) => content.classList.remove("active"));

          // Add active class to clicked tab and corresponding content
          event.target.classList.add("active");
          if (tabName === "register") {
            document.getElementById("registerTab").classList.add("active");
          } else if (tabName === "registered") {
            document.getElementById("registeredTab").classList.add("active");
          } else if (tabName === "submissions") {
            document.getElementById("submissionsTab").classList.add("active");
          }
        }

        // Generate Player ID
        function generatePlayerId(handedness) {
          let id = handedness;
          for (let i = 0; i < 4; i++) {
            id += Math.floor(Math.random() * 5 + 1);
          }
          return id;
        }

        //  Player ID availability
        async function validatePlayerId(playerId) {
          try {
            const response = await fetch(
              "https://p7asm2xpue.execute-api.ap-south-1.amazonaws.com/prod/validate",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ playerId: playerId }),
              }
            );

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            return result.available === true || result.exists === false;
          } catch (error) {
            console.error("Player ID validation error:", error);
            return false;
          }
        }

        // Generate unique Player ID with validation
        async function generateUniquePlayerId(handedness) {
          const playerId = generatePlayerId(handedness);
          console.log("Generated Player ID (validation bypassed):", playerId);
          return playerId;
        }

        // Email sending functionality using EmailJS
        function sendWelcomeEmail(playerName, playerEmail, playerId) {
          return new Promise((resolve, reject) => {
            const emailStatus = document.getElementById("emailStatus");

            try {
              emailStatus.style.display = "block";
              emailStatus.className = "email-status sending";
              emailStatus.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending welcome email...';

              // Send email using EmailJS v4 API
              emailjs
                .send(
                  "", // Replace with your actual service ID
                  "", // Replace with your actual template ID
                  {
                    to_email: playerEmail,
                    player_name: playerName,
                    player_id: playerId,
                    to_name: playerName,
                    from_name: "Player Registration Team",
                  }
                )
                .then((response) => {
                  emailStatus.className = "email-status sent";
                  emailStatus.innerHTML = `<i class="fa-solid fa-circle-check"></i> Welcome email sent successfully to ${playerEmail}!`;
                  resolve(response);
                })
                .catch((error) => {
                  emailStatus.className = "email-status failed";
                  emailStatus.innerHTML = `<i class="fa-solid fa-circle-xmark"></i> Email sending failed: ${error?.text || error?.message || "Unknown error occurred"}`;
                  reject(error);
                });
            } catch (error) {
              emailStatus.className = "email-status failed";
              emailStatus.innerHTML = `<i class="fa-solid fa-circle-xmark"></i> Email sending failed: ${error?.message || "Unknown error occurred"}`;
              reject(error);
            }
          });
        }

        // Input sanitization function
        function sanitizeInput(input) {
          return input.trim().replace(/[<>]/g, "");
        }

        // Register Player functionality - Enhanced with better error handling
        document
          .getElementById("registerForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            submitPlayer();
          });

        async function submitPlayer() {
          const handedness = document.getElementById("playerHandedness").value;
          const playerName = sanitizeInput(
            document.getElementById("playerName").value
          );
          const playerAge = document.getElementById("playerAge").value.trim();
          const playerEmail = sanitizeInput(
            document.getElementById("playerEmail").value
          );

          // Get all the new angle fields
          const stanceAngle = document
            .getElementById("stanceAngle")
            .value.trim();
          const forwardDefenceEndAngle = document
            .getElementById("forwardDefenceEndAngle")
            .value.trim();
          const forwardDriveEndAngle = document
            .getElementById("forwardDriveEndAngle")
            .value.trim();
          const backwardDefenceEndAngle = document
            .getElementById("backwardDefenceEndAngle")
            .value.trim();
          const backwardDriveEndAngle = document
            .getElementById("backwardDriveEndAngle")
            .value.trim();
          const cutEndAngle = document
            .getElementById("cutEndAngle")
            .value.trim();
          const pullEndAngle = document
            .getElementById("pullEndAngle")
            .value.trim();

          const registerMsg = document.getElementById("registerMessage");
          const submitBtn = document.querySelector(
            '#registerForm button[type="submit"]'
          );

          // Clear previous messages
          registerMsg.className = "message";
          registerMsg.textContent = "";
          document.getElementById("emailStatus").style.display = "none";

          // Updated validation to include all fields
          if (
            !playerName ||
            !playerAge ||
            !handedness ||
            !playerEmail ||
            !stanceAngle ||
            !forwardDefenceEndAngle ||
            !forwardDriveEndAngle ||
            !backwardDefenceEndAngle ||
            !backwardDriveEndAngle ||
            !cutEndAngle ||
            !pullEndAngle
          ) {
            registerMsg.textContent =
              "Please fill in all required fields including all angle measurements.";
            registerMsg.className = "message error";
            return;
          }

          // Enhanced email validation
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(playerEmail)) {
            registerMsg.textContent = "Please enter a valid email address.";
            registerMsg.className = "message error";
            return;
          }

          // Age validation
          const age = parseInt(playerAge);
          if (age < 5 || age > 100) {
            registerMsg.textContent = "Age must be between 5 and 100 years.";
            registerMsg.className = "message error";
            return;
          }

          // Name validation
          if (playerName.length < 2) {
            registerMsg.textContent =
              "Name must be at least 2 characters long.";
            registerMsg.className = "message error";
            return;
          }

          // Angle validation
          const angles = [
            { value: parseFloat(stanceAngle), name: "Stance Angle" },
            {
              value: parseFloat(forwardDefenceEndAngle),
              name: "Forward Defence End Angle",
            },
            {
              value: parseFloat(forwardDriveEndAngle),
              name: "Forward Drive End Angle",
            },
            {
              value: parseFloat(backwardDefenceEndAngle),
              name: "Backward Defence End Angle",
            },
            {
              value: parseFloat(backwardDriveEndAngle),
              name: "Backward Drive End Angle",
            },
            { value: parseFloat(cutEndAngle), name: "Cut End Angle" },
            { value: parseFloat(pullEndAngle), name: "Pull End Angle" },
          ];

          for (let angle of angles) {
            if (isNaN(angle.value) || angle.value < 0 || angle.value > 360) {
              registerMsg.textContent = `${angle.name} must be a valid number between 0 and 360 degrees.`;
              registerMsg.className = "message error";
              return;
            }
          }

          // Updated payload to include all angle fields
          try {
            const originalText = submitBtn.textContent;
            submitBtn.textContent = "Generating Player ID...";
            submitBtn.disabled = true;

            // Generate unique player ID with validation
            let playerId;
            try {
              playerId = await generateUniquePlayerId(handedness);
            } catch (error) {
              registerMsg.textContent = error.message;
              registerMsg.className = "message error";
              submitBtn.textContent = originalText;
              submitBtn.disabled = false;
              return;
            }

            const payload = {
              playerId,
              name: playerName,
              age: playerAge,
              email: playerEmail,
              handedness: handedness === "1" ? "Left" : "Right",
              stanceAngle: parseFloat(stanceAngle),
              forwardDefenceEndAngle: parseFloat(forwardDefenceEndAngle),
              forwardDriveEndAngle: parseFloat(forwardDriveEndAngle),
              backwardDefenceEndAngle: parseFloat(backwardDefenceEndAngle),
              backwardDriveEndAngle: parseFloat(backwardDriveEndAngle),
              cutEndAngle: parseFloat(cutEndAngle),
              pullEndAngle: parseFloat(pullEndAngle),
              timestamp: new Date().toISOString(),

              // Add pitch and roll data for each captured angle
              angleData: {
                stanceAngle: capturedAngleData.stanceAngle || null,
                forwardDefenceEndAngle:
                  capturedAngleData.forwardDefenceEndAngle || null,
                forwardDriveEndAngle:
                  capturedAngleData.forwardDriveEndAngle || null,
                backwardDefenceEndAngle:
                  capturedAngleData.backwardDefenceEndAngle || null,
                backwardDriveEndAngle:
                  capturedAngleData.backwardDriveEndAngle || null,
                cutEndAngle: capturedAngleData.cutEndAngle || null,
                pullEndAngle: capturedAngleData.pullEndAngle || null,
              },
            };

            // Show the generated player ID to user
            registerMsg.textContent = `Generated Player ID: ${playerId}. Now registering...`;
            registerMsg.className = "message success";

            submitBtn.textContent = "Registering...";

            const response = await fetch(
              "Your API endpoint here", // Replace with your actual API endpoint
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              }
            );

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            registerMsg.textContent = `Player registered successfully! ID: ${playerId} (Validated as unique)`;
            registerMsg.className = "message success";

            // Send welcome email
            try {
              await sendWelcomeEmail(playerName, playerEmail, playerId);
            } catch (emailError) {
              console.error("Email sending failed:", emailError);
              // Don't show error to user as registration was successful
            }

            // Clear form - Clear all new fields and captured data
            document.getElementById("playerName").value = "";
            document.getElementById("playerAge").value = "";
            document.getElementById("playerEmail").value = "";
            document.getElementById("playerHandedness").value = "";
            document.getElementById("stanceAngle").value = "";
            document.getElementById("forwardDefenceEndAngle").value = "";
            document.getElementById("forwardDriveEndAngle").value = "";
            document.getElementById("backwardDefenceEndAngle").value = "";
            document.getElementById("backwardDriveEndAngle").value = "";
            document.getElementById("cutEndAngle").value = "";
            document.getElementById("pullEndAngle").value = "";

            // Clear captured angle data
            capturedAngleData = {};
            clearAngleDisplays();

            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          } catch (err) {
            console.error("Registration error:", err);
            registerMsg.textContent = `Error registering player: ${
              err.message || "Please try again."
            }`;
            registerMsg.className = "message error";

            submitBtn.textContent = "Register Player";
            submitBtn.disabled = false;
          }
        }

        function resetAngleField(fieldId) {
          const input = document.getElementById(fieldId);
          const resetBtn =
            input.parentElement.querySelector(".reset-angle-btn");

          if (input) {
            input.value = "";
            input.classList.remove("angle-input-readonly");

            // Update the display box
            const displayElementId =
              "display" + fieldId.charAt(0).toUpperCase() + fieldId.slice(1);
            const displayElement = document.getElementById(displayElementId);

            if (displayElement) {
              displayElement.textContent = "Not captured";
              displayElement.style.color = "#666";
              displayElement.style.fontWeight = "normal";
            }

            // Visual feedback for reset button
            const originalText = resetBtn.innerHTML;
            resetBtn.innerHTML = '<i class="fa-solid fa-circle-check"></i> Reset';
            resetBtn.disabled = true;

            setTimeout(() => {
              resetBtn.innerHTML = originalText;
              resetBtn.disabled = false;
            }, 1000);
          }
        }

        // Update the existing clearAngleDisplays function to reset all displays
        function clearAngleDisplays() {
          const angleTypes = [
            "stanceAngle",
            "forwardDefenceEndAngle",
            "forwardDriveEndAngle",
            "backwardDefenceEndAngle",
            "backwardDriveEndAngle",
            "cutEndAngle",
            "pullEndAngle",
          ];

          angleTypes.forEach((angleType) => {
            const displayElementId =
              "display" +
              angleType.charAt(0).toUpperCase() +
              angleType.slice(1);
            const displayElement = document.getElementById(displayElementId);

            if (displayElement) {
              displayElement.textContent = "Not captured";
              displayElement.style.color = "#666";
              displayElement.style.fontWeight = "normal";
            }
          });

          document.getElementById("anglesTimestamp").textContent = "Not set";
        }

        // Fetch Registered Players functionality
        async function fetchRegisteredPlayers() {
          const registeredDiv = document.getElementById("registeredPlayers");
          const loadingDiv = document.getElementById("registeredLoading");
          const loadBtn = document.querySelector(
            'button[onclick="fetchRegisteredPlayers()"]'
          );

          try {
            loadingDiv.style.display = "block";
            registeredDiv.innerHTML = "";
            loadBtn.disabled = true;

            // Replace with your actual API endpoint for fetching registered players
            const response = await fetch(
              "Your API endpoint here"
            );

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }



            const data = await response.json();

            loadingDiv.style.display = "none";
            loadBtn.disabled = false;

            if (!Array.isArray(data) || data.length === 0) {
              registeredDiv.innerHTML =
                '<p style="text-align: center; color: #666; padding: 2rem;">No registered players found.</p>';
              allRegisteredPlayers = [];
              return;
            }

            // Sort by timestamp in descending order (newest first)
            const sortedData = [...data].sort((a, b) => {
              const aTime = new Date(a.timestamp || 0).getTime();
              const bTime = new Date(b.timestamp || 0).getTime();
              return bTime - aTime; // Descending order (newest first)
            });

            // Store sorted data globally for filtering
            allRegisteredPlayers = sortedData;
            displayRegisteredPlayers(sortedData);
          } catch (err) {
            console.error("Fetch registered players error:", err);
            loadingDiv.style.display = "none";
            loadBtn.disabled = false;
            registeredDiv.innerHTML = `<p style="text-align: center; color: #e53e3e; padding: 2rem;">Error loading registered players: ${err.message}</p>`;
            allRegisteredPlayers = [];
          }
        }

        // Display registered players with collapsible details
        function displayRegisteredPlayers(players) {
          const registeredDiv = document.getElementById("registeredPlayers");

          if (!players || players.length === 0) {
            registeredDiv.innerHTML =
              '<p style="text-align: center; color: #666; padding: 2rem;">No players to display.</p>';
            return;
          }

          registeredDiv.innerHTML = "";

          players.forEach((player, index) => {
            // Enhanced timestamp formatting
            let timestamp = "Unknown";
            if (player.timestamp) {
              try {
                const date = new Date(player.timestamp);
                if (!isNaN(date.getTime()) && date.getFullYear() >= 2020) {
                  timestamp = date.toLocaleString();
                } else {
                  // Try parsing as epoch timestamp
                  const epochDate = new Date(parseInt(player.timestamp) * 1000);
                  if (
                    !isNaN(epochDate.getTime()) &&
                    epochDate.getFullYear() >= 2020
                  ) {
                    timestamp = epochDate.toLocaleString();
                  } else {
                    timestamp = `Invalid date (${player.timestamp})`;
                  }
                }
              } catch (error) {
                timestamp = `Error parsing date (${player.timestamp})`;
              }
            }

            const playerContainer = document.createElement("div");
            playerContainer.className = "player-card-container";

            playerContainer.innerHTML = `
      <!-- Collapsible Header -->
      <div class="player-card-header" onclick="togglePlayerDetails('registered-${index}')">
        <div class="player-summary">
          <div class="player-summary-item">
            <div class="player-summary-label">Player ID</div>
            <div class="player-summary-value">${
              player.playerId || player.player_id || "Unknown"
            }</div>
          </div>
          <div class="player-summary-item">
            <div class="player-summary-label">Name</div>
            <div class="player-summary-value">${player.name || "Unknown"}</div>
          </div>
          <div class="player-summary-item">
            <div class="player-summary-label">Age</div>
            <div class="player-summary-value">${player.age || "Unknown"}</div>
          </div>
          <div class="player-summary-item">
            <div class="player-summary-label">Handedness</div>
            <div class="player-summary-value">${
              player.handedness || "Unknown"
            }</div>
          </div>
          <div class="player-summary-item">
            <div class="player-summary-label">Registered</div>
            <div class="player-summary-value">${timestamp}</div>
          </div>
        </div>
        <div class="expand-arrow" id="arrow-registered-${index}">▼</div>
      </div>

      <!-- Collapsible Details -->
      <div class="player-details-container" id="details-registered-${index}">
        <div class="player-details">
          <div class="player-detail">
            <div class="player-detail-label">Email</div>
            <div class="player-detail-value">${player.email || "Unknown"}</div>
          </div>
          <div class="player-detail">
            <div class="player-detail-label">Stance Angle</div>
            <div class="player-detail-value">${
              player.stanceAngle !== undefined
                ? player.stanceAngle + "°"
                : "Not recorded"
            }</div>
          </div>
          <div class="player-detail">
            <div class="player-detail-label">Forward Defence End Angle</div>
            <div class="player-detail-value">${
              player.forwardDefenceEndAngle !== undefined
                ? player.forwardDefenceEndAngle + "°"
                : "Not recorded"
            }</div>
          </div>
          <div class="player-detail">
            <div class="player-detail-label">Forward Drive End Angle</div>
            <div class="player-detail-value">${
              player.forwardDriveEndAngle !== undefined
                ? player.forwardDriveEndAngle + "°"
                : "Not recorded"
            }</div>
          </div>
          <div class="player-detail">
           
            <div class="player-detail-label">
              Backward Defence End Angle
            </div>
            <div class="player-detail-value">${
              player.backwardDefenceEndAngle !== undefined
                ? player.backwardDefenceEndAngle + "°"
                : "Not recorded"
            }</div>
          </div>
          <div class="player-detail">
            <div class="player-detail-label">
              Backward Drive End Angle
            </div>
            <div class="player-detail-value">${
              player.backwardDriveEndAngle !== undefined
                ? player.backwardDriveEndAngle + "°"
                : "Not recorded"
            }</div>
          </div>
          <div class="player-detail">
            <div class="player-detail-label">Cut End Angle</div>
            <div class="player-detail-value">${
              player.cutEndAngle !== undefined
                ? player.cutEndAngle + "°"
                : "Not recorded"
            }</div>
          </div>
          <div class="player-detail">
            <div class="player-detail-label">Pull End Angle</div>
            <div class="player-detail-value">${
              player.pullEndAngle !== undefined
                ? player.pullEndAngle + "°"
                : "Not recorded"
            }</div>
          </div>
        </div>
      </div>
    `;

            registeredDiv.appendChild(playerContainer);
          });
        }

        function displaySubmissions(submissions) {
          const submissionsDiv = document.getElementById("submissions");

          if (!submissions || submissions.length === 0) {
            submissionsDiv.innerHTML =
              '<p style="text-align: center; color: #666; padding: 2rem;">No submissions to display.</p>';
            return;
          }

          submissionsDiv.innerHTML = "";

          // Sort submissions by submission_id_manual in descending order (newest first)
          const sortedSubmissions = [...submissions].sort((a, b) => {
            const aId = parseInt(a.submission_id_manual) || 0;
            const bId = parseInt(b.submission_id_manual) || 0;
            return bId - aId; // Descending order
          });

          sortedSubmissions.forEach((submission, index) => {
            // Format timestamp properly
            let timestamp = "Unknown";
            if (submission.timestamp) {
              let timestampValue = parseInt(submission.timestamp);

              if (timestampValue < 10000000000) {
                timestampValue = timestampValue * 1000;
              } else if (timestampValue.toString().length === 13) {
                timestampValue = timestampValue;
              } else {
                timestampValue = timestampValue * 1000;
              }

              const date = new Date(timestampValue);

              if (
                !isNaN(date.getTime()) &&
                date.getFullYear() >= 2020 &&
                date.getFullYear() <= 2030
              ) {
                timestamp = date.toLocaleString();
              } else {
                timestamp = `Invalid date (${submission.timestamp})`;
              }
            }

            // Check if this submission has enhanced bat data
            const hasEnhancedBatData =
              submission.has_enhanced_bat_data === true ||
              submission.data_type === "performance_update_enhanced_combined" ||
              (submission.bat_grip_correct_count !== undefined &&
                submission.bat_grip_correct_count !== null &&
                submission.bat_grip_correct_count !== "");

            const submissionContainer = document.createElement("div");
            submissionContainer.className = "player-card-container";

            submissionContainer.innerHTML = `
      <!-- Collapsible Header -->
      <div class="player-card-header submission-card-header" onclick="togglePlayerDetails('submission-${index}')">
        <div class="submission-summary">
          <div class="player-summary-item">
            <div class="player-summary-label">Player ID</div>
            <div class="player-summary-value">${
              submission.player_id || "Unknown"
            }</div>
          </div>
          <div class="player-summary-item">
            <div class="player-summary-label">Drill Type</div>
            <div class="player-summary-value">${
              submission.drill_type || "Unknown"
            }</div>
          </div>
          <div class="player-summary-item">
            <div class="player-summary-label">Success Rate</div>
            <div class="player-summary-value">${
              submission.total_success_rate !== undefined &&
              submission.total_success_rate !== null &&
              submission.total_success_rate !== ""
                ? submission.total_success_rate + "%"
                : "0%"
            }</div>
          </div>
          <div class="player-summary-item">
            <div class="player-summary-label">Submitted</div>
            <div class="player-summary-value">${timestamp}</div>
          </div>
        </div>
        <div class="expand-arrow submission-expand-arrow" id="arrow-submission-${index}">▼</div>
      </div>

      <!-- Collapsible Details -->
      <div class="player-details-container" id="details-submission-${index}">
        <div class="player-details">
          <div class="player-detail">
            <div class="player-detail-label">Handedness</div>
            <div class="player-detail-value">${
              submission.handedness || "Unknown"
            }</div>
          </div>
          
          <!-- Overall Performance -->
          <div class="segment-header">
              <div class="player-detail-label">OVERALL PERFORMANCE</div>
          </div>
          <div class="player-detail performance-metric">
              <div class="player-detail-label">Total Drill Count</div>
              <div class="player-detail-value">${
                submission.total_drill_count !== undefined &&
                submission.total_drill_count !== null &&
                submission.total_drill_count !== ""
                  ? submission.total_drill_count
                  : submission.drill_count || "0"
              }</div>
          </div>
          <div class="player-detail performance-metric">
              <div class="player-detail-label">Total Correct Count</div>
              <div class="player-detail-value">${
                submission.total_correct_count !== undefined &&
                submission.total_correct_count !== null &&
                submission.total_correct_count !== ""
                  ? submission.total_correct_count
                  : "0"
              }</div>
          </div>
          <div class="player-detail performance-metric">
              <div class="player-detail-label">Total Wrong Count</div>
              <div class="player-detail-value">${
                submission.total_wrong_count !== undefined &&
                submission.total_wrong_count !== null &&
                submission.total_wrong_count !== ""
                  ? submission.total_wrong_count
                  : "0"
              }</div>
          </div>
          <div class="player-detail performance-metric">
              <div class="player-detail-label">Segments Participated</div>
              <div class="player-detail-value">${
                submission.segments_participated !== undefined &&
                submission.segments_participated !== null &&
                submission.segments_participated !== ""
                  ? Array.isArray(submission.segments_participated)
                    ? submission.segments_participated.join(", ")
                    : submission.segments_participated
                  : "Unknown"
              }</div>
          </div>
          
          <!-- Foot Segment Performance -->
          ${
            submission.foot_segment_participated === true ||
            submission.foot_segment_participated === "true"
              ? `
          <div class="segment-header foot-segment">
              <div class="player-detail-label">FOOT SEGMENT PERFORMANCE</div>
          </div>
          <div class="player-detail foot-performance performance-metric">
              <div class="player-detail-label">Foot Drill Count</div>
              <div class="player-detail-value">${
                submission.foot_drill_count !== undefined &&
                submission.foot_drill_count !== null &&
                submission.foot_drill_count !== ""
                  ? submission.foot_drill_count
                  : "0"
              }</div>
          </div>
          <div class="player-detail foot-performance performance-metric">
              <div class="player-detail-label">Foot Correct Count</div>
              <div class="player-detail-value">${
                submission.foot_correct_count !== undefined &&
                submission.foot_correct_count !== null &&
                submission.foot_correct_count !== ""
                  ? submission.foot_correct_count
                  : "0"
              }</div>
          </div>
          <div class="player-detail foot-performance performance-metric">
              <div class="player-detail-label">Foot Wrong Count</div>
              <div class="player-detail-value">${
                submission.foot_wrong_count !== undefined &&
                submission.foot_wrong_count !== null &&
                submission.foot_wrong_count !== ""
                  ? submission.foot_wrong_count
                  : "0"
              }</div>
          </div>
          <div class="player-detail foot-performance performance-metric">
              <div class="player-detail-label">Foot Success Rate</div>
              <div class="player-detail-value">${
                submission.foot_success_rate !== undefined &&
                submission.foot_success_rate !== null &&
                submission.foot_success_rate !== ""
                  ? submission.foot_success_rate + "%"
                  : "0%"
              }</div>
          </div>
          `
              : ""
          }
          
          <!-- Bat Segment Performance -->
          ${
            submission.bat_segment_participated === true ||
            submission.bat_segment_participated === "true"
              ? `
          <div class="segment-header bat-segment">
              <div class="player-detail-label">BAT SEGMENT PERFORMANCE</div>
          </div>
          
          <!-- Standard Bat Performance Metrics -->
          <div class="player-detail bat-performance performance-metric">
              <div class="player-detail-label">Bat Drill Count</div>
              <div class="player-detail-value">${
                submission.bat_drill_count !== undefined &&
                submission.bat_drill_count !== null &&
                submission.bat_drill_count !== ""
                  ? submission.bat_drill_count
                  : "0"
              }</div>
          </div>
          <div class="player-detail bat-performance performance-metric">
              <div class="player-detail-label">Bat Overall Correct</div>
              <div class="player-detail-value">${
                submission.bat_correct_count !== undefined &&
                submission.bat_correct_count !== null &&
                submission.bat_correct_count !== ""
                  ? submission.bat_correct_count
                  : "0"
              }</div>
          </div>
          <div class="player-detail bat-performance performance-metric">
              <div class="player-detail-label">Bat Overall Wrong</div>
              <div class="player-detail-value">${
                submission.bat_wrong_count !== undefined &&
                submission.bat_wrong_count !== null &&
                submission.bat_wrong_count !== ""
                  ? submission.bat_wrong_count
                  : "0"
              }</div>
          </div>
          <div class="player-detail bat-performance performance-metric">
              <div class="player-detail-label">Bat Overall Success Rate</div>
              <div class="player-detail-value">${
                submission.bat_success_rate !== undefined &&
                submission.bat_success_rate !== null &&
                submission.bat_success_rate !== ""
                  ? submission.bat_success_rate + "%"
                  : "0%"
              }</div>
          </div>

          <!-- Enhanced Bat Performance Metrics (Grip & Angle) -->
          ${
            hasEnhancedBatData
              ? `
          <div class="player-detail bat-performance" style="grid-column: 1 / -1; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #ff9a56;">
              <div class="player-detail-label" style="color: #ff9a56; font-weight: bold; text-align: center;">GRIP PERFORMANCE BREAKDOWN</div>
          </div>
          <div class="player-detail bat-performance performance-metric">
              <div class="player-detail-label">Grip Correct Count</div>
              <div class="player-detail-value" style="color: #11998e; font-weight: bold;">${
                submission.bat_grip_correct_count !== undefined &&
                submission.bat_grip_correct_count !== null &&
                submission.bat_grip_correct_count !== ""
                  ? submission.bat_grip_correct_count
                  : "0"
              }</div>
          </div>
          <div class="player-detail bat-performance performance-metric">
              <div class="player-detail-label">Grip Wrong Count</div>
              <div class="player-detail-value" style="color: #e53e3e; font-weight: bold;">${
                submission.bat_grip_wrong_count !== undefined &&
                submission.bat_grip_wrong_count !== null &&
                submission.bat_grip_wrong_count !== ""
                  ? submission.bat_grip_wrong_count
                  : "0"
              }</div>
          </div>
          <div class="player-detail bat-performance performance-metric">
              <div class="player-detail-label">Grip Success Rate</div>
              <div class="player-detail-value" style="color: #4facfe; font-weight: bold;">${
                submission.bat_grip_success_rate !== undefined &&
                submission.bat_grip_success_rate !== null &&
                submission.bat_grip_success_rate !== ""
                  ? submission.bat_grip_success_rate + "%"
                  : "0%"
              }</div>
          </div>
          
          <div class="player-detail bat-performance" style="grid-column: 1 / -1; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #ff9a56;">
              <div class="player-detail-label" style="color: #ff9a56; font-weight: bold; text-align: center;">ANGLE PERFORMANCE BREAKDOWN</div>
          </div>
          <div class="player-detail bat-performance performance-metric">
              <div class="player-detail-label">Angle Correct Count</div>
              <div class="player-detail-value" style="color: #11998e; font-weight: bold;">${
                submission.bat_angle_correct_count !== undefined &&
                submission.bat_angle_correct_count !== null &&
                submission.bat_angle_correct_count !== ""
                  ? submission.bat_angle_correct_count
                  : "0"
              }</div>
          </div>
          <div class="player-detail bat-performance performance-metric">
              <div class="player-detail-label">Angle Wrong Count</div>
              <div class="player-detail-value" style="color: #e53e3e; font-weight: bold;">${
                submission.bat_angle_wrong_count !== undefined &&
                submission.bat_angle_wrong_count !== null &&
                submission.bat_angle_wrong_count !== ""
                  ? submission.bat_angle_wrong_count
                  : "0"
              }</div>
          </div>
          <div class="player-detail bat-performance performance-metric">
              <div class="player-detail-label">Angle Success Rate</div>
              <div class="player-detail-value" style="color: #4facfe; font-weight: bold;">${
                submission.bat_angle_success_rate !== undefined &&
                submission.bat_angle_success_rate !== null &&
                submission.bat_angle_success_rate !== ""
                  ? submission.bat_angle_success_rate + "%"
                  : "0%"
              }</div>
          </div>
          `
              : `
          <div class="player-detail bat-performance" style="grid-column: 1 / -1; margin-top: 0.5rem;">
              <div class="player-detail-label" style="color: #666; font-style: italic; text-align: center;">Enhanced grip/angle data not available for this submission</div>
          </div>
          `
          }
          `
              : ""
          }
        </div>
      </div>
    `;

            submissionsDiv.appendChild(submissionContainer);
          });
        }

        function filterSubmissions() {
          const searchTerm = document
            .getElementById("submissionSearch")
            .value.toLowerCase()
            .trim();

          if (!searchTerm) {
            displaySubmissions(allSubmissions);
            return;
          }

          const filteredSubmissions = allSubmissions.filter((submission) => {
            const playerId = (submission.player_id || "")
              .toString()
              .toLowerCase();
            const handedness = (submission.handedness || "").toLowerCase();
            const drillType = (submission.drill_type || "").toLowerCase();
            const submissionId = (submission.submission_id_manual || "")
              .toString()
              .toLowerCase();
            const dataType = (submission.data_type || "").toLowerCase();

            // NEW: Search in enhanced bat performance data
            const gripCorrect = (submission.bat_grip_correct_count || "")
              .toString()
              .toLowerCase();
            const gripWrong = (submission.bat_grip_wrong_count || "")
              .toString()
              .toLowerCase();
            const angleCorrect = (submission.bat_angle_correct_count || "")
              .toString()
              .toLowerCase();
            const angleWrong = (submission.bat_angle_wrong_count || "")
              .toString()
              .toLowerCase();
            const gripSuccess = (submission.bat_grip_success_rate || "")
              .toString()
              .toLowerCase();
            const angleSuccess = (submission.bat_angle_success_rate || "")
              .toString()
              .toLowerCase();

            return (
              playerId.includes(searchTerm) ||
              handedness.includes(searchTerm) ||
              drillType.includes(searchTerm) ||
              submissionId.includes(searchTerm) ||
              dataType.includes(searchTerm) ||
              gripCorrect.includes(searchTerm) ||
              gripWrong.includes(searchTerm) ||
              angleCorrect.includes(searchTerm) ||
              angleWrong.includes(searchTerm) ||
              gripSuccess.includes(searchTerm) ||
              angleSuccess.includes(searchTerm) ||
              (searchTerm.includes("enhanced") &&
                (submission.has_enhanced_bat_data === true ||
                  submission.data_type ===
                    "performance_update_enhanced_combined")) ||
              (searchTerm.includes("grip") &&
                submission.bat_grip_correct_count !== undefined) ||
              (searchTerm.includes("angle") &&
                submission.bat_angle_correct_count !== undefined)
            );
          });

          displaySubmissions(filteredSubmissions);
        }

        // Filter players based on search input
        function filterPlayers() {
          const searchTerm = document
            .getElementById("playerSearch")
            .value.toLowerCase()
            .trim();

          if (!searchTerm) {
            displayRegisteredPlayers(allRegisteredPlayers);
            return;
          }

          const filteredPlayers = allRegisteredPlayers.filter((player) => {
            const playerId = (player.playerId || player.player_id || "")
              .toString()
              .toLowerCase();
            const name = (player.name || "").toLowerCase();
            const email = (player.email || "").toLowerCase();

            return (
              playerId.includes(searchTerm) ||
              name.includes(searchTerm) ||
              email.includes(searchTerm)
            );
          });

          // Filtered results will maintain the original sort order (newest first)
          displayRegisteredPlayers(filteredPlayers);
        }

        // Fetch Submissions functionality - Enhanced error handling
        async function fetchSubmissions() {
          const submissionsDiv = document.getElementById("submissions");
          const loadingDiv = document.getElementById("submissionsLoading");
          const loadBtn = document.querySelector(
            'button[onclick="fetchSubmissions()"]'
          );

          try {
            loadingDiv.style.display = "block";
            submissionsDiv.innerHTML = "";
            loadBtn.disabled = true;

            const response = await fetch(
              "Your API endpoint here" // Replace with your actual API endpoint for fetching submissions
            );

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            loadingDiv.style.display = "none";
            loadBtn.disabled = false;

            if (!Array.isArray(data) || data.length === 0) {
              submissionsDiv.innerHTML =
                '<p style="text-align: center; color: #666; padding: 2rem;">No submissions found.</p>';
              return;
            }

            // Store data globally for filtering
            allSubmissions = data;
            displaySubmissions(data);
          } catch (err) {
            console.error("Fetch submissions error:", err);
            loadingDiv.style.display = "none";
            loadBtn.disabled = false;
            submissionsDiv.innerHTML = `<p style="text-align: center; color: #e53e3e; padding: 2rem;">Error loading submissions: ${err.message}</p>`;
            allSubmissions = [];
          }
        }

        // Allow Enter key to submit login
        document.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            if (
              document
                .getElementById("loginSection")
                .classList.contains("active")
            ) {
              const activeElement = document.activeElement;
              if (
                activeElement &&
                (activeElement.id === "username" ||
                  activeElement.id === "password")
              ) {
                login();
              }
            }
          }
        });

        // Toggle player details visibility
        function togglePlayerDetails(detailsId) {
          const detailsContainer = document.getElementById(
            `details-${detailsId}`
          );
          const arrow = document.getElementById(`arrow-${detailsId}`);

          if (detailsContainer && arrow) {
            const isExpanded = detailsContainer.classList.contains("expanded");

            if (isExpanded) {
              // Collapse
              detailsContainer.classList.remove("expanded");
              arrow.classList.remove("expanded");
            } else {
              // Expand
              detailsContainer.classList.add("expanded");
              arrow.classList.add("expanded");
            }
          }
        }
      </script>
    </div>
  </body>
</html>
